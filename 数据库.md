### 1. Innodb 是如何实现事务的

Innodb 通过 Buffer Pool，LogBuffer，Redo Log，Undo Log 来实现事务，以一个 update 语句为例:

1. Innodb 在收到一个update语句后，会先根据条件找到数据所在的页，并将该页缓存在 Buffer Pool 中
2. 执行 update 语句，修改 Buffer Pool 中的数据，也就是内存中的数据
3. 针对 update 语句生成一个 RedoLog 对象，并存入 LogBuffer 中
4. 针对 update 语句生成 undolog 日志，用于事务回滚
5. 如果事务提交，那么则把 Redolog 对象进行持久化，后续还有其他机制将 Buffer Pool 中所修改的数据页持久化到磁盘中
6. 如果事务回滚，则利用 undolog 日志进行回滚

### 2. 零时刻导致 Flyway 执行失败

运行时，历史脚本中的 Flyway 失败，因为带有时间戳的脚本没有默认值。检查本地 MySQL 环境的 sql_mode，删除`NO_ZERO_DATE`和`NO_ZERO_IN_DATE`。

```sql
SELECT @@GLOBAL.sql_mode;
--- SET时移除NO_ZERO_DATE和NO_ZERO_IN_DATE
SET GLOBAL sql_mode = "ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION";
```

### 3. SQL Server (Compact Edition)

#### 3.1 SQL CE 中 sp_rename 仅支持表的修改

```sql
sp_rename 'oldTableName','newTableName';
```

在 SqlServer 2005 Management Studio 中，您必须使用新名称创建一个新列，然后使用旧列中的值更新它，然后删除旧列。如果列是索引的一部分，那么最后一个操作是困难的。

#### 3.2 SQL CE 查询表信息

```sql
SELECT table_name_, column_name FROM INFORMATION_SCHEMA.COLUMNS WHERE table_name_='stu';
```

#### 3.3 SQL CE 和其他 SQL 的区别

- [SQL CE 3.5 和其他 SQL 的区别](https://docs.microsoft.com/zh-cn/previous-versions/sql/compact/sql-server-compact-3.5/bb896140(v=sql.100))
- [SQL CE 3.5 SP2和其他 SQL 的区别](https://docs.microsoft.com/zh-cn/previous-versions/sql/compact/sql-server-compact-3.5-sp2/bb896140(v=sql.105))
- [SQL CE 4.0和其他 SQL 的区别](https://docs.microsoft.com/zh-cn/previous-versions/sql/compact/sql-server-compact-4.0/bb896140(v=sql.110))

#### 3.4 SQL CE 使用 EFCore 连接并持久化对象：

https://entityframework-extensions.net/efcore-sql-server-compact-provider

   #### 3.5 确定Firebird SQL版本

   ```sql
SELECT rdb$get_context('SYSTEM', 'ENGINE_VERSION')  as version from rdb$database;
   ```

### 4. 不同数据库之间的类型映射关系

- 常用关键字翻译

| **T-sql**                                                    | **postgres**                                                 |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| cast(`value` AS datetime)<br>convert(datetime, `value`)      | cast(`value` AS timestamp(3))                                |
| datepart(day, `value`)                                       | extract(day FROM `value`)                                    |
| dateadd(day, `value1`, `value2`)                             | `value2` + `value1` * INTERVAL '1 day'                       |
| dateadd(d,-1,dateadd(mm, datediff(m,0,`column_name`)+1,0))<br>当月的最后一天 | date_trunc('month', `column_name`) + INTERVAL '1 month- 1 day' |
| len(`value`)                                                 | char_length(`value`)                                         |
| +                                                            | \|\|                                                         |
| IDENTITY (1,1)                                               | GENERATED BY DEFAULT AS IDENTITY                             |
| ROWVERSION                                                   | bytea                                                        |
| CREATE TABLE `table_name` (`column_name` varbinary(46) NOT NULL DEFAULT ((0))) | CREATE TABLE `table_name` (`column_name` bytea NOT NULL DEFAULT E'\\x00000000') |
| DECLARE `@tablename` TABLE(`column_name1` nvarchar(500), `column_name2` nvarchar(500)) | CREATE TEMPORARY TABLE `tablename` (`column_name1` nvarchar(500), `column_name2` nvarchar(500))<br>WITH `tablename` AS (SELECT …) |
| NOCHECK CONSTRAINT all<br>WITH CHECK CHECK CONSTRAINT all    | DISABLE TRIGGER ALL<br>ENABLE TRIGGER ALL                    |

- 常用类型映射

| **SQL Server**                 | **Postgres**                                                 |
| :----------------------------- | :----------------------------------------------------------- |
| smallint                       | smallint, int2                                               |
| int                            | integer, int, int4                                           |
| bigint                         | bigint, int8                                                 |
| tinyint                        | **不支持**                                                   |
| float(n)  `1 <= n <= 24`, real | float(n)  `1 <= n <= 24`, real, float4                       |
| float(n)  `25 <= n <= 53`      | double precision, float(n)  `25 <= n <= 53`, float8          |
| numeric, decimal               | numeric, decimal                                             |
| money, smallmoney              | money<br>In SQL Server, money is `(19,4)` and smallmoney is `(10,4)` in , but  in Postgres money is `(19,2)` |
| varbinary(n)                   | bytea with check<br />Postgres uses 'check' to simulate `n`  |
| varbinary(max), image          | bytea                                                        |
| binary(n)                      | **不支持**                                                   |
| date                           | date                                                         |
| datetime                       | timestamp(3) without time zone                               |
| datetime2(n)                   | timestamp(n) without time zone<br>In SQL Server `0 <= n <= 7`, but in Postgres `0 <= n <=6` |
| datetimeoffset(n)              | timestamp(n) with time zone, timestamptz<br>In SQL Server `0 <= n <= 7`, but in Postgres `0 <= n <=6` |
| bit                            | bit, bit(1), boolean, bool                                   |
| char(n)                        | character(n), char(n)                                        |
| nchar(n)                       | character(n), char(n)<br>For UCS-2 encoding, the storage size is two times n bytes |
| varchar(n)                     | character varying(n), varchar(n)                             |
| nvarchar(n)                    | character varying(n), varchar(n)<br>For UCS-2 encoding, the storage size is two times n bytes |
| text                           | text                                                         |
| ntext                          | text                                                         |


- Postgres pg_stat_statements

```sql
Create Extension pg_stat_statements;
Select * from pg_available_extensions where name = 'pg_stat_statements';
```

### 5. ChangeDB

#### 5.1 安装ChangeDB

[yscorecore/changedb (github.com)](https://github.com/yscorecore/changedb)
dotnet SDK 6.0
dotnet tool restore
dotnet tool install changedb.consoleapp -g
dotnet tool list -g

#### 5.2 运行命令

```bash
changedb migration {source-database-type} "{source-connection-string}" {target-database-type} "{target-connection-string}" 
```

sqlserver -> postgres

```bash
changedb migration sqlserver "Data Source=(LocalDB)\MSSQLLocalDB;Initial Catalog=<DatabaseName>;Integrated Security=SSPI;"
postgres "Server=127.0.0.1;Port=5432;Database=<PostgresDatabaseName>;User Id=<postgres>;Password=<xxxxxx>;"
```

sqlce -> sqlserver

```bash
ChangeDb migration --max-fetch-bytes 10000 sqlce "Data Source=C:\xxxxxx.myox;Max Database Size=2048; Persist Security Info=False;" 
sqlserver "Data Source=(LocalDB)\MSSQLLocalDB;Initial Catalog=<DatabaseName>;Integrated Security=SSPI;"
```

sqlce -> postgres

```bash
ChangeDb migration --max-fetch-bytes 10000 sqlce "Data Source=C:\xxxxxx.myox;Max Database Size=2048; Persist Security Info=False;" 
postgres "Server=localhost;port=5432;Database={DBName};User Id=postgres;Password={PASSWORD}"
```

#### 5.3 复制数据库备份

```sql
CREATE DATABASE db_backup WITH TEMPLATE "db"
```